<h2> Review scores: <%= Participant.find(@reviewer_id).name(session[:ip]) %> </h2>

<% keys = @review_final_versions.keys %>
<% keys.each do |key| %>

    <h4>Course: <%= Assignment.find(@assignment_id).course.name %></h4>
    <h4> Assignment: <%= Assignment.find(@assignment_id).name %></h4>
    <% roundtitle = key.to_s %>
    <h4><%= roundtitle.titlecase %></h4>

    <table class="general" border="1">
      <% questionnaire_id = Questionnaire.find(@review_final_versions[key][:questionnaire_id]) %>
      <% questions = Question.where(questionnaire_id: questionnaire_id) %>
      <% num_responses = @review_final_versions[key][:response_ids].length %>
      <% responses = @review_final_versions[key][:response_ids] %>
<!--      set column length of responses-->
      <% col_percent = 100/num_responses%>
      <% col_percent_comment = 100/num_responses - 1%>
      <td colspan="3" style="padding: 0px;">
        <table width="100%">
          <tr>
            <% responses.each do |response_id| %>
                <% team = Team.find(ResponseMap.find(Response.find(response_id).map_id).reviewee_id) %>
                <td><%= team.name(session[:ip]) %></td>
            <% end %>
          </tr>
        </table>
      </td>

      <% questions.each do |question| %>
          <% if !question.is_a?(QuestionnaireHeader) && num_responses > 0 %>
              <% if question.instance_of? Checkbox %>
                  <tr>
                    <td colspan="3" style="padding: 0px;">
                      <table width="100%">
                        <tr>
                          <!-- question -->
                          <th style="background-color:#DDDDBB" width="50%">[Question]<%= question.txt %></th>
                          <!-- checkbox -->
                          <% responses.each do |response_id| %>
                              <% answer = Answer.where(response_id: response_id, question_id: question.id).first %>
                              <td style="float:left" align="center" width="<%= col_percent %>%">
                                <p><%= answer.answer == 0 ? image_tag("delete_icon.png") : image_tag("Check-icon.png") %></p></td>
                          <% end %>
                        </tr>
                      </table>
                    </td>
                  </tr>
              <% else %>
                  <tr>
                    <th colspan="3" style="background-color:#DDDDBB" > [Question]<%= question.txt %></th>
                  </tr>
                  <!-- Only assign these column headers if the question isn't a checkbox question -->
                  <tr>
                    <td colspan="3" style="padding: 0px;">
                      <table width="100%">
                        <tr>
                          <% responses.each do|response_id| %>
                              <% answer = Answer.where(response_id: response_id, question_id: question.id).first %>
                              <% if !answer.nil? %><% team = Team.find(ResponseMap.find(Response.find(response_id).map_id).reviewee_id) %>
                                  <% response_map = ReviewResponseMap.where(reviewed_object_id: @assignment_id,
                                                                            reviewer_id: @reviewer_id,
                                                                            reviewee_id: team.id).last %>
                                  <% response_update_at = response_map.try(:response).try(:last).try(:updated_at) %>
                                  <% review_graded_at = ReviewGrade.find_by(participant_id: @reviewer_id).try(:review_graded_at) %>
                                  <% col_color = 'black' %>
                                  <% col_color = 'blue' if review_graded_at && response_update_at && response_update_at > review_graded_at %>
                                  <!--Score-->
                                  <% if question.instance_of? Checkbox %>
                                      <td align='center'>
                                        <p style="color: <%= col_color %>"><%= answer.answer == 0 ? image_tag("delete_icon.png") : image_tag("Check-icon.png") %></p>
                                      </td>
                                  <% else %>
                                      <td align='center' width="1%"><p style="color: <%= col_color %>"><%= answer.answer %></p></td>
                                  <% end %>
                                  <!--Comments-->
                                  <td align='left' width="<%= col_percent_comment %>%"><p style="color: <%= col_color %>;width: 100%"><%= answer.comments.html_safe unless answer.comments.nil? %></p></td>
                              <% else %>
                                  <td>N/A</td>
                                  <td>N/A</td>
                              <% end %>
                          <% end %>
                        </tr>
                      </table>
                    </td>
                  </tr>
              <% end %>
          <% else %>
              <% next%>
          <% end %>
      <% end %>
      <tr>
        <th align='left' colspan="2" style="background-color:#DDDDBB"> Additional Comment</th>
      </tr>
      <tr>
        <td colspan="3" style="padding: 0px;">
          <table width="100%">
            <tr>
              <% responses.each do |response_id| %>
                  <% team = Team.find(ResponseMap.find(Response.find(response_id).map_id).reviewee_id) %>
                    <td colspan="2" width="<%= col_percent %>%"> <%=sanitize Response.find(response_id).additional_comment %> </td>
              <% end %>
            </tr>
          </table>
      </tr>
    </table>

<% end #loop for keys %>
<br/>